# 任务书：贴吧故事自动化视频生成（Tieba Story Video）

## 1. 项目概述
- 项目名称：贴吧故事自动化视频生成
- 目标：把贴吧故事帖从“抓取→整理→分镜→生图→配音→配乐→合成”流水线产出可播放视频，并保留可追溯关系。
- 约束：本地优先、成本可控、API Key 不可泄露、不过度自动化到触发风控。

## 2. 交付物清单（文档与产物）
### 2.1 文档
- [需求分析.md](file:///d:/AI/trae/tieba_story/docs/%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90.md)
- [软件设计书.md](file:///d:/AI/trae/tieba_story/docs/%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1%E4%B9%A6.md)
- 本任务书（本文件）

### 2.2 工程产物（实现阶段）
- 抓取输出：JSON/CSV/图片目录
- LLM 输出：summary/storyboard/bgm plan JSON
- 渲染输出：镜头图、旁白音频、BGM
- 最终输出：mp4 + manifest

## 3. 里程碑计划（建议按阶段验收）

### M0：环境与安全基线（1–2 天）
**目标**
- 保障所有密钥/账号不进入版本库
- 明确本地目录与依赖安装位置（非系统盘）

**完成标准**
- 根目录 `.gitignore` 已覆盖本地密钥、`.env`、抓取产物、构建产物
- 本地配置文件示例清晰（例如 `docs/aliyun_api-key.example.md`）

### M1：单帖抓取与结构化（2–4 天）
**范围**
- 输入一个帖子 URL，导出 `raw.json` 与 `details.csv`，可选下载图片

**完成标准**
- 至少对 3 个帖子 URL 抓取成功
- 抓取失败能给出明确提示（验证码/频率/重新登录）

### M2：故事整理与要点提炼（2–4 天）
**范围**
- 读取结构化楼层，LLM 生成故事正文 + 要点 + 映射

**完成标准**
- 输出 JSON，包含段落与楼层映射
- 允许重跑并复用缓存（同输入得到一致输出或记录版本差异）
- 当帖子包含图片时，支持 VLM + LLM 联合理解（图片内容可追溯引用）

### M3：分镜生成（2–4 天）
**范围**
- 将整理文本拆分为分镜（>= 8 镜头），每镜头可直接用于生图与配音

**完成标准**
- `storyboard.json` 具备：画面描述、旁白文本、映射信息、提示词
- 抽样检查 10 条分镜，均能回指原文楼层范围

### M4：生图与 TTS（3–7 天）
**范围**
- 生成至少 3 张镜头图与 3 段旁白音频（MVP）

**完成标准**
- 生成物落盘并带 manifest（模型、参数、时间）
- 失败可重试并定位原因（配额、参数错误、网络问题）

### M5：BGM 方案与下载（2–4 天）
**范围**
- LLM 给出配乐风格与候选；用下载工具获取音频（本地预览）

**完成标准**
- `bgm.plan.json` 含理由与风险提示
- 音频文件可被后续合成步骤加载

### M6：Remotion 合成与最终视频（3–7 天）
**范围**
- 将镜头图、旁白、BGM 合成 mp4

**完成标准**
- 生成可播放 mp4
- 旁白与镜头时间对齐（至少不明显错位）
- 输出 manifest 记录渲染参数

## 4. 工作分解（WBS）

### 4.1 抓取与解析
- 完成登录态复用、失败回退、限流重试
- 输出标准化 JSON/CSV

### 4.2 LLM 任务链
- 总结提示词设计（强制引用楼层证据）
- 分镜提示词设计（镜头可执行、可生图、可配音）
- 选曲提示词设计（情绪、BPM、版权风险提示）

### 4.3 生成与合成
- 生图参数策略（统一风格、可控 seed）
- TTS 音色与语速策略
- Remotion 合成策略（时长、字幕、音量 ducking）

### 4.4 工程化
- 统一产物目录与 manifest
- 缓存与可重跑机制
- 错误归一化与可视化日志

## 5. 风险与对策（执行层面）
- 贴吧风控：降低频率、分批抓取、必要时人工介入验证码
- LLM 幻觉：分阶段总结、输出必须带楼层引用、抽样人工校对
- 成本失控：限制镜头数、缓存中间产物、生图/TTS 可选开关
- 版权风险：默认本地学习；发布前引入版权确认与替换清单

## 6. 进度跟踪模板（每周/每次迭代）
建议每次迭代更新以下表格（可直接复制追加）：

| 日期 | 目标里程碑 | 本次完成 | 阻塞问题 | 下次计划 | 备注 |
|---|---|---|---|---|---|
| YYYY-MM-DD | M? |  |  |  |  |
| 2026-02-02 | M2 | 按 3–4 字/秒 优化总结分段 | 无 | 开始 M3 分镜生成 | summary 可直接用于 2–3 分钟旁白 |
| 2026-02-02 | M3 | 生成 10 条分镜（含旁白与 trace） | 无 | 开始 M4 旁白/音频合成 | storyboard 总时长约 178 秒 |
| 2026-02-02 | M3/M4 | 渲染测试：生成前 2 镜头图片+配音 | 无 | 扩展渲染到全 10 镜头；再进入合成视频 | 使用 qwen-image 文生图；scene_2 以 scene_1 为参考保证画风一致 |
| 2026-02-02 | M4 | 配音改为播报腔偏低并重新测试 | 无 | 扩展渲染到全 10 镜头并统一男声旁白 | 当前使用 qwen3-tts-flash voice=Neil |
| 2026-02-02 | M4 | 生图与TTS MVP 达成（>=3镜头） | 无 | 推进 M5 选曲与下载 | 证据：projects/9461449190/render/manifest.json |
| 2026-02-02 | M5 | 生成 BGM 方案并完成下载 | 无 | 推进 M6 合成视频 | 证据：projects/9461449190/llm/bgm.plan.json；projects/9461449190/assets/bgm/manifest.json |
| 2026-02-02 | M6 | 用 Remotion 合成 3 镜头 MVP 视频 | 无 | 视之后效果扩展到 10 镜头并微调节奏 | 证据：output/9461449190.m6.mp4；output/9461449190.m6.manifest.json |
| 2026-02-04 | M6+ | 重写分镜并扩展到 10 镜头，合成新版视频 | 无 | 重写 docs 并固化端到端测试 | 证据：projects/9461449190/llm/storyboard.json；projects/9461449190/render/manifest.json；output/9461449190.revamp.v2.mp4；output/workspace_test_report.9461449190.json |

## 7. 验收记录模板
| 里程碑 | 验收项 | 结果 | 证据路径 | 备注 |
|---|---|---|---|---|
| M0 | 安全基线就绪 | ✅ | .gitignore；docs/aliyun_api-key.example.md | 根目录已忽略 projects/output/.env/密钥等 |
| M1 | 单帖抓取成功 | ✅ | projects/9461449190；projects/8434934848；projects/6324611301 | 使用既有 CSV 导入为标准产物 |
| M2 | 故事整理含映射 | ✅ | projects/9461449190/llm/story.summary.json；projects/8434934848/llm/story.summary.json；projects/6324611301/llm/story.summary.json；tools/tieba_m2_summarize.py | 8434934848/6324611301 已启用 VLM+LLM 联合理解（图片描述缓存见 projects/*/llm/vlm.image_descriptions.json） |
| M3 | 分镜表 >= 8 | ✅ | projects/9461449190/llm/storyboard.json；tools/tieba_m3_storyboard.py | 生成 10 条分镜，含旁白与 trace（段落+楼层映射），总时长约 178 秒 |
| M4 | 生图与 TTS | ✅ | projects/9461449190/render/manifest.json；projects/9461449190/render/images；projects/9461449190/render/audio；tools/tieba_m3_render_assets.py | 已生成 >=3 镜头图与 >=3 段旁白；图片一致性采用“上一张图参考编辑”（edit_prev）；旁白为播报腔偏低 voice=Neil |
| M5 | BGM 方案与下载 | ✅ | projects/9461449190/llm/bgm.plan.json；projects/9461449190/assets/bgm/manifest.json；projects/9461449190/assets/bgm/bgm.mp3；tools/tieba_m5_bgm_plan.py；tools/tieba_m5_bgm_download.py | 选择 CC BY 4.0 音乐并明确署名要求 |
| M6 | 输出 mp4 可播放 | ✅ | output/9461449190.m6.mp4；output/9461449190.m6.manifest.json；remotion_video | 3 镜头 MVP：Remotion 合成成功，可播放，含旁白+播报腔+BGM |
| M6+ | 10 镜头重写与质感升级 | ✅ | output/9461449190.revamp.v2.mp4；projects/9461449190/llm/storyboard.json；projects/9461449190/render/manifest.json；tools/workspace_e2e_test.py | 重写脚本与分镜，扩展到 10 镜头并完成生图+TTS；字幕分段与 BGM ducking；工作区端到端测试可复现 |

### M1（已完成：导入 3 个帖子样例数据到 projects/）
| 帖子URL | 结果 | 证据路径 |
|---|---|---|
| https://tieba.baidu.com/p/9461449190 | ✅ | projects/9461449190/source/raw.json, projects/9461449190/source/details.csv |
| https://tieba.baidu.com/p/8434934848 | ✅ | projects/8434934848/source/raw.json, projects/8434934848/source/details.csv |
| https://tieba.baidu.com/p/6324611301 | ✅ | projects/6324611301/source/raw.json, projects/6324611301/source/details.csv |
