# 需求分析：Tieba Story Video（单帖工程化短片生成）

## 1. 背景
- 贴吧故事帖往往篇幅长、口语化、信息噪声多（尾巴/水贴/引用混杂），主线难以快速获得。
- 目标不是“批量无人值守发布”，而是把单个帖子沉淀成可播放、可复盘、可迭代的短片工程：文本→分镜→素材→合成。

## 2. 本次改造目标（以 9461449190 为样例）
### 2.1 必须实现
- **叙事升级**：同一素材重写为克制的纪实旁白短片，结构清晰（Hook→建立关系→转折→离别→多年后回望）。
- **镜头升级**：分镜固定为 10 镜头，镜头间逻辑连续，旁白每镜头 1–2 句，避免长段堆叠。
- **素材完备**：10 镜头都具备图片（或可合成视觉画面）与旁白音频（TTS），并能合成 mp4。
- **合成质感提升**：字幕分段渐进、BGM ducking、统一色调/暗角等视觉基线。
- **可测试**：工作区提供端到端测试脚本，一键验证工具链可用、产物可生成。
- **文档重写**：`docs/` 内文档与实际实现一致，并以“可复现”为中心描述。

### 2.2 非目标（本次不承诺）
- 不承诺对所有帖子自动抓取成功（风控/结构变化仍需维护）。
- 不做大规模素材库/音乐库商业分发链路；默认只用于本地生成预览。
- 不做“完全无人值守”的交互式 Claude Code 自动化（工具输入限制导致不可审计/不可复现）。

## 3. 用户与使用场景
- **个人创作者**：把一个故事帖快速转成可迭代短片。
- **工程实验**：研究“可追溯内容生成”与“可编程视频合成”流水线。

典型场景（MVP）：
1. 输入帖子 URL 或直接提供 `projects/{post_id}/source/*`
2. 生成/更新 `llm/storyboard.json`（分镜+旁白+提示词）
3. 生成镜头图与旁白音频到 `render/`
4. 选择并下载 BGM 到 `assets/bgm/`
5. Remotion 合成输出 mp4 到 `output/`

## 4. 功能需求
### 4.1 数据与产物（强制落盘）
- 单帖工程目录：`projects/{post_id}/`
  - `source/`：抓取证据（raw.json、details.csv 等）
  - `llm/`：summary/storyboard/bgm 计划
  - `render/`：images/audio/manifest.json
  - `assets/`：bgm/manifest.json
- 输出目录：`output/`（视频与测试报告）

### 4.2 LLM 协作（仅使用可审计模式）
- 使用 `claude -p/--print` 进行协作输出（文本/JSON），保证结果可回传、可落盘、可验收。
- 旁白与分镜输出要求：每镜头必须可执行（能生成一张图 + 一段音频）。

### 4.3 生图与 TTS
- 支持按镜头生成图片与音频，并在 `render/manifest.json` 中记录模型、参数、时间与失败信息。
- 支持一致性策略（如 `edit_prev`）以保证画风统一。

### 4.4 Remotion 合成
- 输入：`render/images`、`render/audio`、`assets/bgm`、`llm/storyboard.json`
- 输出：`output/{post_id}.*.mp4`
- 合成规则：
  - 字幕从旁白生成，按标点分段，逐段出现
  - BGM ducking：旁白段落降低 BGM 音量并做淡入淡出
  - 统一色调与轻暗角，避免“纯幻灯片”观感

## 5. 非功能需求
### 5.1 可追溯性
- 任一视频产物可追溯到：post_url/post_id、分镜（scene_id）、旁白文本、生成时间与工具版本。

### 5.2 安全与隐私
- API Key 必须只存在本地且被 `.gitignore` 覆盖（例如 `docs/aliyun_api-key.md`）。
- 输出中不得包含 Cookie/Token 等敏感信息。

### 5.3 可测试性
- 提供工作区端到端测试脚本，覆盖：
  - tools/*.py --help
  - 关键流水线脚本（M5/M6）
  - Remotion compositions 与最小渲染
  - 输出文件存在性与基本字段校验

## 6. 验收标准（以 9461449190 为准）
- 10 镜头分镜文件存在且结构正确：`projects/9461449190/llm/storyboard.json`
- 10 镜头图片与音频生成成功：`projects/9461449190/render/images|audio`
- 新版视频可播放：`output/9461449190.revamp.v2.mp4`
- 工作区测试通过并生成报告：`output/workspace_test_report.9461449190.json`

