# 软件设计书：Tieba Story Video（单帖工程流水线）

## 1. 设计目标
- 将一个贴吧故事帖转换为可播放短片，并保留从原文到视频的可追溯关系。
- 将“设计系统 → 脚本/分镜 → 素材 → 合成 → 测试”工程化，强调可复现与可迭代。
- 协作仅采用 `claude -p` 等可审计方式，避免不可回溯的交互式自动化。

## 2. 总体架构
### 2.1 单帖工程目录
`projects/{post_id}/` 为一个自洽工程，目录约定：
- `source/`：抓取证据（raw.json、details.csv）
- `llm/`：story.summary.json、storyboard.json、bgm.plan.json
- `render/`：images/、audio/、manifest.json（渲染清单）
- `assets/`：bgm/（含 bgm.mp3 与 manifest.json）

最终输出：
- `output/`：视频与工作区测试报告

### 2.2 流水线阶段
- **M2 Summarize**：从 `source/*` 生成 `llm/story.summary.json`
- **M3 Storyboard**：从 summary 生成 `llm/storyboard.json`
- **M4 Render Assets**：从 storyboard 生成 `render/images` 与 `render/audio`，并写入 `render/manifest.json`
- **M5 BGM**：生成 `llm/bgm.plan.json` 并下载到 `assets/bgm`
- **M6 Compose (Remotion)**：将素材同步到 `remotion_video/public/{post_id}/`，构建 props 并渲染 mp4

## 3. 数据结构
### 3.1 storyboard.json（关键）
- 顶层：`post_url, post_id, title, synopsis, scenes[]`
- `scenes[]` 每条至少包含：
  - `scene_id`：1..N
  - `duration_s`：镜头秒数
  - `voiceover_text`：旁白（用于 TTS + 字幕）
  - `prompt.positive/negative`：生图提示词

### 3.2 render/manifest.json
- 记录每个 scene 的图片与音频文件名、旁白文本、时长、生成元数据与失败信息。

### 3.3 Remotion props（TiebaStoryProps）
- `scenes[]`：每条包含 `image/audio/duration_s/subtitle` 等渲染所需字段
- `bgm`：src + volume

## 4. 关键模块
### 4.1 协作模块（claude -p）
目标：把“编剧/导演/测试开发”的工作以可审计方式产出。
- 输入：提示词（可来自 `.trae/skills/claude-code-interactive-collab/assets/*`）
- 输出：文本/JSON，可直接落盘复用

### 4.2 生图与 TTS（tools/tieba_m3_render_assets.py）
输入：`projects/{post_id}/llm/storyboard.json`  
输出：`projects/{post_id}/render/*` 与 `render/manifest.json`

一致性策略：
- `--consistency-mode edit_prev`：后续镜头参考上一张图做风格一致

### 4.3 Remotion 合成（remotion_video）
- 资源目录：`remotion_video/public/{post_id}/images|audio|bgm`
- props 构建：`tools/tieba_m6_build_props.py`
- 资源同步：`tools/tieba_m6_sync_public.py`
- 合成规则（TiebaStory 组合）：
  - Ken Burns 推拉 + 轻位移，避免静态幻灯片
  - 字幕按标点分段逐段出现
  - BGM ducking：旁白段落降低音量并淡入淡出
  - 统一色调与暗角叠层

## 5. 端到端测试
`tools/workspace_e2e_test.py` 覆盖：
- tools/*.py 的 `--help` 可用性
- M5/M6 关键脚本可运行
- Remotion compositions 中包含 TiebaStory
- 最小渲染（0-30 帧优先）产出 mp4 非零大小
- props 文件字段完整性检查

输出报告：`output/workspace_test_report.{post_id}.json`

## 6. 安全与隐私
- `.gitignore` 必须忽略：
  - `docs/aliyun_api-key.md`、`.env`、`projects/`、`output/`
- 视频与文档输出中不得出现任何密钥或登录态信息。

